#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
YAML_FILE="$SCRIPT_DIR/deps.yaml"
DEPS_FILE="$SCRIPT_DIR/deps"

log() { echo "[+] $1"; }

# -------------------------------------------------
# Refresh mirrors and update system
# -------------------------------------------------
refresh_mirrors() {
    log "Refreshing pacman mirrors and updating system"
    sudo pacman -Syy --noconfirm
}

# -------------------------------------------------
# Install package with retries
# -------------------------------------------------
pacman_install_retry() {
    local pkg="$1"
    if ! pacman -Qi "$pkg" >/dev/null 2>&1; then
        log "Installing $pkg via pacman"
        sudo pacman -S --needed --noconfirm "$pkg"
    else
        log "$pkg already installed"
    fi
}

# -------------------------------------------------
# Generate deps from deps.yaml
# -------------------------------------------------
generate_deps() {
    if [[ ! -f "$YAML_FILE" ]]; then
        log "No deps.yaml found, skipping deps generation"
        return
    fi

    if ! command -v yq >/dev/null 2>&1; then
        log "yq not found, installing yq"
        refresh_mirrors
        pacman_install_retry yq
    fi

    log "Generating deps from deps.yaml"
    yq -r '.[] | .[]' "$YAML_FILE" > "$DEPS_FILE"
}

# -------------------------------------------------
# Check if a package is in official repos
# -------------------------------------------------
is_official_repo() {
    local pkg="$1"
    if pacman -Si "$pkg" >/dev/null 2>&1; then
        return 0  # official repo
    else
        return 1  # likely AUR
    fi
}

# -------------------------------------------------
# Install deps with pacman or yay (critical)
# -------------------------------------------------
install_deps() {
    if [[ ! -f "$DEPS_FILE" ]]; then
        log "No deps file found, skipping installation"
        return
    fi

    while read -r pkg; do
        [[ -z "$pkg" || "$pkg" =~ ^# ]] && continue  # skip empty or comments

        if is_official_repo "$pkg"; then
            log "Installing $pkg from official repos"
            pacman_install_retry "$pkg"
        else
            log "Installing $pkg from AUR via yay"
            yay -S --needed --noconfirm "$pkg"
        fi
    done < "$DEPS_FILE"
}

# -------------------------------------------------
# Ensure yay exists
# -------------------------------------------------
if command -v yay >/dev/null 2>&1; then
    log "yay already installed"
    yay --version
else
    log "yay not found, installing..."
    refresh_mirrors
    pacman_install_retry git
    pacman_install_retry base-devel

    TMP_DIR="$(mktemp -d)"
    trap 'rm -rf "$TMP_DIR"' EXIT

    git clone https://aur.archlinux.org/yay.git "$TMP_DIR/yay"
    cd "$TMP_DIR/yay"
    makepkg -si --noconfirm
fi

# -------------------------------------------------
# Generate deps and install (critical)
# -------------------------------------------------
generate_deps
install_deps

# -------------------------------------------------
# Track failed optional packages
# -------------------------------------------------
FAILED_PKGS=()

install_optional_pkg() {
    local pkg="$1"
    log "Attempting to install optional package: $pkg"
    if ! yay -S --needed --noconfirm "$pkg"; then
        log "⚠ Failed to install $pkg"
        FAILED_PKGS+=("$pkg")
    fi
}

# Example: Brave browser (optional)
install_optional_pkg brave-bin

# -------------------------------------------------
# Install uv (Python tooling, critical)
# -------------------------------------------------
if ! command -v uv >/dev/null 2>&1; then
    log "Installing uv"
    curl -LsSf https://astral.sh/uv/install.sh | sh
else
    log "uv already installed"
fi

# -------------------------------------------------
# Dotfiles / tooling
# -------------------------------------------------
TOOLS_SCRIPT="$HOME/Workspace/dotfiles/.tools/sym.sh"
if [[ -x "$TOOLS_SCRIPT" ]]; then
    log "Running dotfiles symlink script"
    "$TOOLS_SCRIPT"
else
    log "Dotfiles script not found or not executable, skipping"
fi

# -------------------------------------------------
# Report failed optional packages
# -------------------------------------------------
if [[ ${#FAILED_PKGS[@]} -gt 0 ]]; then
    log ""
    log "Some optional packages failed to install:"
    for pkg in "${FAILED_PKGS[@]}"; do
        echo "  - $pkg"
    done
else
    log "All optional packages installed successfully"
fi

log "✅ Bootstrap complete"
